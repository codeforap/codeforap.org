/**
 * Copyright (C) 2010-2015 Graham Breach
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
/**
 * TagCanvas 2.7
 * For more information, please contact <graham@goat1000.com>
 */
(function(){var M,K,L=Math.abs,ag=Math.sin,w=Math.cos,s=Math.max,aB=Math.min,ao=Math.ceil,F=Math.sqrt,aq=Math.pow,h={},l={},m={0:"0,",1:"17,",2:"34,",3:"51,",4:"68,",5:"85,",6:"102,",7:"119,",8:"136,",9:"153,",a:"170,",A:"170,",b:"187,",B:"187,",c:"204,",C:"204,",d:"221,",D:"221,",e:"238,",E:"238,",f:"255,",F:"255,"},x,c,Q,aD,H,aE,aa,C=document,p,b={};for(M=0;M<256;++M){K=M.toString(16);if(M<16){K="0"+K}l[K]=l[K.toUpperCase()]=M.toString()+","}function ah(i){return typeof i!="undefined"}function I(i){return typeof i=="object"&&i!=null}function at(i,j,aF){return isNaN(i)?aF:aB(aF,s(j,i))}function ay(){return false}function G(){return new Date().valueOf()}function A(aF,aI){var j=[],aG=aF.length,aH;for(aH=0;aH<aG;++aH){j.push(aF[aH])}j.sort(aI);return j}function am(j){var aG=j.length-1,aF,aH;while(aG){aH=~~(Math.random()*aG);aF=j[aG];j[aG]=j[aH];j[aH]=aF;--aG}}function ad(i,aF,j){this.x=i;this.y=aF;this.z=j}H=ad.prototype;H.length=function(){return F(this.x*this.x+this.y*this.y+this.z*this.z)};H.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z};H.cross=function(j){var i=this.y*j.z-this.z*j.y,aG=this.z*j.x-this.x*j.z,aF=this.x*j.y-this.y*j.x;return new ad(i,aG,aF)};H.angle=function(j){var i=this.dot(j),aF;if(i==0){return Math.PI/2}aF=i/(this.length()*j.length());if(aF>=1){return 0}if(aF<=-1){return Math.PI}return Math.acos(aF)};H.unit=function(){var i=this.length();return new ad(this.x/i,this.y/i,this.z/i)};function ai(aF,j){j=j*Math.PI/180;aF=aF*Math.PI/180;var i=ag(aF)*w(j),aH=-ag(j),aG=-w(aF)*w(j);return new ad(i,aH,aG)}function R(i){this[1]={1:i[0],2:i[1],3:i[2]};this[2]={1:i[3],2:i[4],3:i[5]};this[3]={1:i[6],2:i[7],3:i[8]}}aD=R.prototype;R.Identity=function(){return new R([1,0,0,0,1,0,0,0,1])};R.Rotation=function(aG,i){var j=ag(aG),aF=w(aG),aH=1-aF;return new R([aF+aq(i.x,2)*aH,i.x*i.y*aH-i.z*j,i.x*i.z*aH+i.y*j,i.y*i.x*aH+i.z*j,aF+aq(i.y,2)*aH,i.y*i.z*aH-i.x*j,i.z*i.x*aH-i.y*j,i.z*i.y*aH+i.x*j,aF+aq(i.z,2)*aH])};aD.mul=function(aF){var aG=[],aJ,aI,aH=(aF.xform?1:0);for(aJ=1;aJ<=3;++aJ){for(aI=1;aI<=3;++aI){if(aH){aG.push(this[aJ][1]*aF[1][aI]+this[aJ][2]*aF[2][aI]+this[aJ][3]*aF[3][aI])}else{aG.push(this[aJ][aI]*aF)}}}return new R(aG)};aD.xform=function(aF){var j={},i=aF.x,aH=aF.y,aG=aF.z;j.x=i*this[1][1]+aH*this[2][1]+aG*this[3][1];j.y=i*this[1][2]+aH*this[2][2]+aG*this[3][2];j.z=i*this[1][3]+aH*this[2][3]+aG*this[3][3];return j};function q(aG,aI,aN,aK){var aJ,aM,j,aL,aO=[],aH=Math.PI*(3-F(5)),aF=2/aG;for(aJ=0;aJ<aG;++aJ){aM=aJ*aF-1+(aF/2);j=F(1-aM*aM);aL=aJ*aH;aO.push([w(aL)*j*aI,aM*aN,ag(aL)*j*aK])}return aO}function W(aH,aF,aK,aQ,aO){var aP,aR=[],aI=Math.PI*(3-F(5)),aG=2/aH,aN,aM,aL,aJ;for(aN=0;aN<aH;++aN){aM=aN*aG-1+(aG/2);aP=aN*aI;aL=w(aP);aJ=ag(aP);aR.push(aF?[aM*aK,aL*aQ,aJ*aO]:[aL*aK,aM*aQ,aJ*aO])}return aR}function N(aF,aG,aJ,aP,aN,aL){var aO,aQ=[],aH=Math.PI*2/aG,aM,aK,aI;for(aM=0;aM<aG;++aM){aO=aM*aH;aK=w(aO);aI=ag(aO);aQ.push(aF?[aL*aJ,aK*aP,aI*aN]:[aK*aJ,aL*aP,aI*aN])}return aQ}function al(aG,i,j,aF){return W(aG,0,i,j,aF)}function ar(aG,i,j,aF){return W(aG,1,i,j,aF)}function d(aH,i,j,aF,aG){aG=isNaN(aG)?0:aG*1;return N(0,aH,i,j,aF,aG)}function n(aH,i,j,aF,aG){aG=isNaN(aG)?0:aG*1;return N(1,aH,i,j,aF,aG)}function an(aF){var j=new Image;j.onload=function(){var aG=j.width/2,i=j.height/2;aF.centreFunc=function(aL,aI,aJ,aH,aK){aL.setTransform(1,0,0,1,0,0);aL.globalAlpha=1;aL.drawImage(j,aH-aG,aK-i)}};j.src=aF.centreImage}function U(aI,i){var aH=aI,aG,aF,j=(i*1).toPrecision(3)+")";if(aI[0]==="#"){if(!h[aI]){if(aI.length===4){h[aI]="rgba("+m[aI[1]]+m[aI[2]]+m[aI[3]]}else{h[aI]="rgba("+l[aI.substr(1,2)]+l[aI.substr(3,2)]+l[aI.substr(5,2)]}}aH=h[aI]+j}else{if(aI.substr(0,4)==="rgb("||aI.substr(0,4)==="hsl("){aH=(aI.replace("(","a(").replace(")",","+j))}else{if(aI.substr(0,5)==="rgba("||aI.substr(0,5)==="hsla("){aG=aI.lastIndexOf(",")+1,aF=aI.indexOf(")");i*=parseFloat(aI.substring(aG,aF));aH=aI.substr(0,aG)+i.toPrecision(3)+")"}}}return aH}function P(i,j){if(window.G_vmlCanvasManager){return null}var aF=C.createElement("canvas");aF.width=i;aF.height=j;return aF}function ak(){var j=P(3,3),aG,aF;if(!j){return false}aG=j.getContext("2d");aG.strokeStyle="#000";aG.shadowColor="#fff";aG.shadowBlur=3;aG.globalAlpha=0;aG.strokeRect(2,2,2,2);aG.globalAlpha=1;aF=aG.getImageData(2,2,1,1);j=null;return(aF.data[0]>0)}function aj(aJ,j,aI,aH){var aG=aJ.createLinearGradient(0,0,j,0),aF;for(aF in aH){aG.addColorStop(1-aF,aH[aF])}aJ.fillStyle=aG;aJ.fillRect(0,aI,j,1)}function k(aH,aF,j){var aG=1024,aL=1,aK=aH.weightGradient,aJ,aN,aI,aM;if(aH.gCanvas){aN=aH.gCanvas.getContext("2d");aL=aH.gCanvas.height}else{if(I(aK[0])){aL=aK.length}else{aK=[aK]}aH.gCanvas=aJ=P(aG,aL);if(!aJ){return null}aN=aJ.getContext("2d");for(aI=0;aI<aL;++aI){aj(aN,aG,aI,aK[aI])}}j=s(aB(j||0,aL-1),0);aM=aN.getImageData(~~((aG-1)*aF),j,1,1).data;return"rgba("+aM[0]+","+aM[1]+","+aM[2]+","+(aM[3]/255)+")"}function X(aO,aH,j,aS,aR,aP,aN,aJ,aG,aQ,aI,aM){var aL=aR+(aJ||0)+(aG.length&&aG[0]<0?L(aG[0]):0),aF=aP+(aJ||0)+(aG.length&&aG[1]<0?L(aG[1]):0),aK,aT;aO.font=aH;aO.textBaseline="top";aO.fillStyle=j;aN&&(aO.shadowColor=aN);aJ&&(aO.shadowBlur=aJ);aG.length&&(aO.shadowOffsetX=aG[0],aO.shadowOffsetY=aG[1]);for(aK=0;aK<aS.length;++aK){aT=0;if(aI){if("right"==aM){aT=aQ-aI[aK]}else{if("centre"==aM){aT=(aQ-aI[aK])/2}}}aO.fillText(aS[aK],aL+aT,aF);aF+=parseInt(aH)}}function ap(aJ,i,aI,j,aG,aH,aF){if(aH){aJ.beginPath();aJ.moveTo(i,aI+aG-aH);aJ.arcTo(i,aI,i+aH,aI,aH);aJ.arcTo(i+j,aI,i+j,aI+aH,aH);aJ.arcTo(i+j,aI+aG,i+j-aH,aI+aG,aH);aJ.arcTo(i,aI+aG,i,aI+aG-aH,aH);aJ.closePath();aJ[aF?"stroke":"fill"]()}else{aJ[aF?"strokeRect":"fillRect"](i,aI,j,aG)}}function g(aL,i,aJ,aG,aK,aF,aH,aI,j){this.strings=aL;this.font=i;this.width=aJ;this.height=aG;this.maxWidth=aK;this.stringWidths=aF;this.align=aH;this.valign=aI;this.scale=j}aa=g.prototype;aa.SetImage=function(aI,j,aG,i,aH,aK,aF,aJ){this.image=aI;this.iwidth=j*this.scale;this.iheight=aG*this.scale;this.ipos=i;this.ipad=aH*this.scale;this.iscale=aJ;this.ialign=aK;this.ivalign=aF};aa.Align=function(j,aF,i){var aG=0;if(i=="right"||i=="bottom"){aG=aF-j}else{if(i!="left"&&i!="top"){aG=(aF-j)/2}}return aG};aa.Create=function(aR,aX,aQ,aY,aW,aV,i,aU,aN){var aL,aJ,aS,a3,a0,aZ,aH,aG,aF,j,aK,aI,aM,aT,a2=L(i[0]),a1=L(i[1]),aO,aP;aU=s(aU,a2+aV,a1+aV);a0=2*(aU+aY);aH=2*(aU+aY);aJ=this.width+a0;aS=this.height+aH;aF=j=aU+aY;if(this.image){aK=aI=aU+aY;aM=this.iwidth;aT=this.iheight;if(this.ipos=="top"||this.ipos=="bottom"){if(aM<this.width){aK+=this.Align(aM,this.width,this.ialign)}else{aF+=this.Align(this.width,aM,this.align)}if(this.ipos=="top"){j+=aT+this.ipad}else{aI+=this.height+this.ipad}aJ=s(aJ,aM+a0);aS+=aT+this.ipad}else{if(aT<this.height){aI+=this.Align(aT,this.height,this.ivalign)}else{j+=this.Align(this.height,aT,this.valign)}if(this.ipos=="right"){aK+=this.width+this.ipad}else{aF+=aM+this.ipad}aJ+=aM+this.ipad;aS=s(aS,aT+aH)}}aL=P(aJ,aS);if(!aL){return null}a0=aH=aY/2;aZ=aJ-aY;aG=aS-aY;a3=aL.getContext("2d");if(aX){a3.fillStyle=aX;ap(a3,a0,aH,aZ,aG,aN)}if(aY){a3.strokeStyle=aQ;a3.lineWidth=aY;ap(a3,a0,aH,aZ,aG,aN,true)}if(aV||a2||a1){aO=P(aJ,aS);if(aO){aP=a3;a3=aO.getContext("2d")}}X(a3,this.font,aR,this.strings,aF,j,0,0,[],this.maxWidth,this.stringWidths,this.align);if(this.image){a3.drawImage(this.image,aK,aI,aM,aT)}if(aP){a3=aP;aW&&(a3.shadowColor=aW);aV&&(a3.shadowBlur=aV);a3.shadowOffsetX=i[0];a3.shadowOffsetY=i[1];a3.drawImage(aO,0,0)}return aL};function v(aG,j,aH){var aF=P(j,aH),aI;if(!aF){return null}aI=aF.getContext("2d");aI.drawImage(aG,(j-aG.width)/2,(aH-aG.height)/2);return aF}function av(aG,j,aH){var aF=P(j,aH),aI;if(!aF){return null}aI=aF.getContext("2d");aI.drawImage(aG,0,0,j,aH);return aF}function aA(aR,aM,aS,aW,aN,aL,aK,aP,aI,aJ){var aG=aM+((2*aP)+aL)*aW,aO=aS+((2*aP)+aL)*aW,aH=P(aG,aO),aV,aU,aF,aT,j,aX,aQ;if(!aH){return null}aL*=aW;aI*=aW;aU=aF=aL/2;aT=aG-aL;j=aO-aL;aP=(aP*aW)+aU;aV=aH.getContext("2d");if(aN){aV.fillStyle=aN;ap(aV,aU,aF,aT,j,aI)}if(aL){aV.strokeStyle=aK;aV.lineWidth=aL;ap(aV,aU,aF,aT,j,aI,true)}if(aJ){aX=P(aG,aO);aQ=aX.getContext("2d");aQ.drawImage(aR,aP,aP,aM,aS);aQ.globalCompositeOperation="source-in";aQ.fillStyle=aK;aQ.fillRect(0,0,aG,aO);aQ.globalCompositeOperation="destination-over";aQ.drawImage(aH,0,0);aQ.globalCompositeOperation="source-over";aV.drawImage(aX,0,0)}else{aV.drawImage(aR,aP,aP,aR.width,aR.height)}return{image:aH,width:aG/aW,height:aO/aW}}function Z(aL,aR,aN,aH,aP,aQ,aG){var aS=L(aG[0]),aM=L(aG[1]),aI=aR+(aS>aQ?aS+aQ:aQ*2)*aH,j=aN+(aM>aQ?aM+aQ:aQ*2)*aH,aK=aH*((aQ||0)+(aG[0]<0?aS:0)),aF=aH*((aQ||0)+(aG[1]<0?aM:0)),aJ,aO;aJ=P(aI,j);if(!aJ){return null}aO=aJ.getContext("2d");aP&&(aO.shadowColor=aP);aQ&&(aO.shadowBlur=aQ*aH);aG&&(aO.shadowOffsetX=aG[0]*aH,aO.shadowOffsetY=aG[1]*aH);aO.drawImage(aL,aK,aF,aR,aN);return{image:aJ,width:aI/aH,height:j/aH}}function t(aR,aJ,aP){var aQ=parseInt(aR.toString().length*aP),aI=parseInt(aP*2*aR.length),aG=P(aQ,aI),aM,j,aH,aL,aO,aN,aF,aK;if(!aG){return null}aM=aG.getContext("2d");aM.fillStyle="#000";aM.fillRect(0,0,aQ,aI);X(aM,aP+"px "+aJ,"#fff",aR,0,0,0,0,[],"centre");j=aM.getImageData(0,0,aQ,aI);aH=j.width;aL=j.height;aK={min:{x:aH,y:aL},max:{x:-1,y:-1}};for(aN=0;aN<aL;++aN){for(aO=0;aO<aH;++aO){aF=(aN*aH+aO)*4;if(j.data[aF+1]>0){if(aO<aK.min.x){aK.min.x=aO}if(aO>aK.max.x){aK.max.x=aO}if(aN<aK.min.y){aK.min.y=aN}if(aN>aK.max.y){aK.max.y=aN}}}}if(aH!=aQ){aK.min.x*=(aQ/aH);aK.max.x*=(aQ/aH)}if(aL!=aI){aK.min.y*=(aQ/aL);aK.max.y*=(aQ/aL)}aG=null;return aK}function o(i){return"'"+i.replace(/(\'|\")/g,"").replace(/\s*,\s*/g,"', '")+"'"}function ac(i,j,aF){aF=aF||C;if(aF.addEventListener){aF.addEventListener(i,j,false)}else{aF.attachEvent("on"+i,j)}}function a(i,j,aF){aF=aF||C;if(aF.removeEventListener){aF.removeEventListener(i,j)}else{aF.detachEvent("on"+i,j)}}function au(aJ,aF,aN,aI){var aO=aI.imageScale,aL,aG,aK,j,aH,aM;if(!aF.complete){return ac("load",function(){au(aJ,aF,aN,aI)},aF)}if(!aJ.complete){return ac("load",function(){au(aJ,aF,aN,aI)},aJ)}aF.width=aF.width;aF.height=aF.height;if(aO){aJ.width=aF.width*aO;aJ.height=aF.height*aO}aN.iw=aJ.width;aN.ih=aJ.height;if(aI.txtOpt){aG=aJ;aL=aI.zoomMax*aI.txtScale;aH=aN.iw*aL;aM=aN.ih*aL;if(aH<aF.naturalWidth||aM<aF.naturalHeight){aG=av(aJ,aH,aM);if(aG){aN.fimage=aG}}else{aH=aN.iw;aM=aN.ih;aL=1}if(!aN.HasText()){if(aI.shadow){aG=Z(aN.image,aH,aM,aL,aI.shadow,aI.shadowBlur,aI.shadowOffset);if(aG){aN.fimage=aG.image;aN.w=aG.width;aN.h=aG.height}}if(aI.bgColour||aI.bgOutlineThickness){aK=aI.bgColour=="tag"?Y(aN.a,"background-color"):aI.bgColour;j=aI.bgOutline=="tag"?Y(aN.a,"color"):(aI.bgOutline||aI.textColour);aH=aN.fimage.width;aM=aN.fimage.height;if(aI.outlineMethod=="colour"){aG=aA(aN.fimage,aH,aM,aL,aK,aI.bgOutlineThickness,aI.outlineColour,aI.padding,aI.bgRadius,1);if(aG){aN.oimage=aG.image}}aG=aA(aN.fimage,aH,aM,aL,aK,aI.bgOutlineThickness,j,aI.padding,aI.bgRadius);if(aG){aN.fimage=aG.image;aN.w=aG.width;aN.h=aG.height}}if(aI.outlineMethod=="size"){if(aI.outlineIncrease>0){aN.iw+=2*aI.outlineIncrease;aN.ih+=2*aI.outlineIncrease;aH=aL*aN.iw;aM=aL*aN.ih;aG=av(aN.fimage,aH,aM);aN.oimage=aG;aN.fimage=v(aN.fimage,aN.oimage.width,aN.oimage.height)}else{aH=aL*(aN.iw+(2*aI.outlineIncrease));aM=aL*(aN.ih+(2*aI.outlineIncrease));aG=av(aN.fimage,aH,aM);aN.oimage=v(aG,aN.fimage.width,aN.fimage.height)}}}}aN.Init()}function Y(aG,aF){var j=C.defaultView,i=aF.replace(/\-([a-z])/g,function(aH){return aH.charAt(1).toUpperCase()});return(j&&j.getComputedStyle&&j.getComputedStyle(aG,null).getPropertyValue(aF))||(aG.currentStyle&&aG.currentStyle[i])}function u(j,aG,aF){var i=1,aH;if(aG){i=1*(j.getAttribute(aG)||aF)}else{if(aH=Y(j,"font-size")){i=(aH.indexOf("px")>-1&&aH.replace("px","")*1)||(aH.indexOf("pt")>-1&&aH.replace("pt","")*1.25)||aH*3.3}}return i}function f(i){return i.target&&ah(i.target.id)?i.target.id:i.srcElement.parentNode.id}function S(aH,aI){var aG,aF,i=parseInt(Y(aI,"width"))/aI.width,j=parseInt(Y(aI,"height"))/aI.height;if(ah(aH.offsetX)){aG={x:aH.offsetX,y:aH.offsetY}}else{aF=ab(aI.id);if(ah(aH.changedTouches)){aH=aH.changedTouches[0]}if(aH.pageX){aG={x:aH.pageX-aF.x,y:aH.pageY-aF.y}}}if(aG&&i&&j){aG.x/=i;aG.y/=j}return aG}function B(aF){var j=aF.target||aF.fromElement.parentNode,i=y.tc[j.id];if(i){i.mx=i.my=-1;i.UnFreeze();i.EndDrag()}}function ae(aJ){var aG,aF=y,j,aI,aH=f(aJ);for(aG in aF.tc){j=aF.tc[aG];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}if(aH&&aF.tc[aH]){j=aF.tc[aH];if(aI=S(aJ,j.canvas)){j.mx=aI.x;j.my=aI.y;j.Drag(aJ,aI)}j.drawn=0}}function z(aG){var j=y,i=C.addEventListener?0:1,aF=f(aG);if(aF&&aG.button==i&&j.tc[aF]){j.tc[aF].BeginDrag(aG)}}function aC(aH){var aF=y,j=C.addEventListener?0:1,aG=f(aH),i;if(aG&&aH.button==j&&aF.tc[aG]){i=aF.tc[aG];ae(aH);if(!i.EndDrag()&&!i.touchState){i.Clicked(aH)}}}function T(aG){var j=f(aG),i=(j&&y.tc[j]),aF;if(i&&aG.changedTouches){if(aG.touches.length==1&&i.touchState==0){i.touchState=1;i.BeginDrag(aG);if(aF=S(aG,i.canvas)){i.mx=aF.x;i.my=aF.y;i.drawn=0}}else{if(aG.targetTouches.length==2&&i.pinchZoom){i.touchState=3;i.EndDrag();i.BeginPinch(aG)}else{i.EndDrag();i.EndPinch();i.touchState=0}}}}function r(aF){var j=f(aF),i=(j&&y.tc[j]);if(i&&aF.changedTouches){switch(i.touchState){case 1:i.Draw();i.Clicked();break;case 2:i.EndDrag();break;case 3:i.EndPinch()}i.touchState=0}}function ax(aJ){var aG,aF=y,j,aI,aH=f(aJ);for(aG in aF.tc){j=aF.tc[aG];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}j=(aH&&aF.tc[aH]);if(j&&aJ.changedTouches&&j.touchState){switch(j.touchState){case 1:case 2:if(aI=S(aJ,j.canvas)){j.mx=aI.x;j.my=aI.y;if(j.Drag(aJ,aI)){j.touchState=2}}break;case 3:j.Pinch(aJ)}j.drawn=0}}function af(aF){var i=y,j=f(aF);if(j&&i.tc[j]){aF.cancelBubble=true;aF.returnValue=false;aF.preventDefault&&aF.preventDefault();i.tc[j].Wheel((aF.wheelDelta||aF.detail)>0)}}function O(){E(G())}function E(aG){var j=y.tc,aF;y.NextFrame(y.interval);aG=aG||G();for(aF in j){j[aF].Draw(aG)}}function ab(aF){var aI=C.getElementById(aF),i=aI.getBoundingClientRect(),aL=C.documentElement,aJ=C.body,aK=window,aG=aK.pageXOffset||aL.scrollLeft,aM=aK.pageYOffset||aL.scrollTop,aH=aL.clientLeft||aJ.clientLeft,j=aL.clientTop||aJ.clientTop;return{x:i.left+aG-aH,y:i.top+aM-j}}function V(j,aG,aH,aF){var i=j.radius*j.z1/(j.z1+j.z2+aG.z);return{x:aG.x*i*aH,y:aG.y*i*aF,z:aG.z,w:(j.z1-aG.z)/j.z2}}function az(i){this.e=i;this.br=0;this.line=[];this.text=[];this.original=i.innerText||i.textContent}aE=az.prototype;aE.Empty=function(){for(var j=0;j<this.text.length;++j){if(this.text[j].length){return false}}return true};aE.Lines=function(aH){var aG=aH?1:0,aI,j,aF;aH=aH||this.e;aI=aH.childNodes;j=aI.length;for(aF=0;aF<j;++aF){if(aI[aF].nodeName=="BR"){this.text.push(this.line.join(" "));this.br=1}else{if(aI[aF].nodeType==3){if(this.br){this.line=[aI[aF].nodeValue];this.br=0}else{this.line.push(aI[aF].nodeValue)}}else{this.Lines(aI[aF])}}}aG||this.br||this.text.push(this.line.join(" "));return this.text};aE.SplitWidth=function(aF,aM,aJ,aI){var aH,aG,aL,aK=[];aM.font=aI+"px "+aJ;for(aH=0;aH<this.text.length;++aH){aL=this.text[aH].split(/\s+/);this.line=[aL[0]];for(aG=1;aG<aL.length;++aG){if(aM.measureText(this.line.join(" ")+" "+aL[aG]).width>aF){aK.push(this.line.join(" "));this.line=[aL[aG]]}else{this.line.push(aL[aG])}}aK.push(this.line.join(" "))}return this.text=aK};function J(i,j){this.ts=G();this.tc=i;this.tag=j;this.x=this.y=this.w=this.h=this.sc=1;this.z=0;this.Draw=i.pulsateTo<1&&i.outlineMethod!="colour"?this.DrawPulsate:this.DrawSimple;this.radius=i.outlineRadius|0;this.SetMethod(i.outlineMethod)}x=J.prototype;x.SetMethod=function(aF){var j={block:["PreDraw","DrawBlock"],colour:["PreDraw","DrawColour"],outline:["PostDraw","DrawOutline"],classic:["LastDraw","DrawOutline"],size:["PreDraw","DrawColour"],none:["LastDraw"]},i=j[aF]||j.outline;if(aF=="none"){this.Draw=function(){return 1}}else{this.drawFunc=this[i[1]]}this[i[0]]=this.Draw};x.Update=function(aL,aK,aM,aH,aI,aJ,aG,i){var j=this.tc.outlineOffset,aF=2*j;this.x=aI*aL+aG-j;this.y=aI*aK+i-j;this.w=aI*aM+aF;this.h=aI*aH+aF;this.sc=aI;this.z=aJ};x.DrawOutline=function(aI,i,aH,j,aF,aG){aI.strokeStyle=aG;ap(aI,i,aH,j,aF,this.radius,true)};x.DrawColour=function(aG,aJ,aH,aK,aF,i,aL,j,aI){if(aL.oimage){aL.alpha=1;aL.Draw(aG,j,aI,aL.oimage);return 1}return this[aL.image?"DrawColourImage":"DrawColourText"](aG,aJ,aH,aK,aF,i,aL,j,aI)};x.DrawColourText=function(aH,aK,aI,aL,aF,i,aM,j,aJ){var aG=aM.colour;aM.colour=i;aM.alpha=1;aM.Draw(aH,j,aJ);aM.colour=aG;return 1};x.DrawColourImage=function(aK,aN,aL,aO,aJ,i,aR,j,aM){var aP=aK.canvas,aH=~~s(aN,0),aG=~~s(aL,0),aI=aB(aP.width-aH,aO)+0.5|0,aQ=aB(aP.height-aG,aJ)+0.5|0,aF;if(p){p.width=aI,p.height=aQ}else{p=P(aI,aQ)}if(!p){return this.SetMethod("outline")}aF=p.getContext("2d");aF.drawImage(aP,aH,aG,aI,aQ,0,0,aI,aQ);aK.clearRect(aH,aG,aI,aQ);aR.alpha=1;aR.Draw(aK,j,aM);aK.setTransform(1,0,0,1,0,0);aK.save();aK.beginPath();aK.rect(aH,aG,aI,aQ);aK.clip();aK.globalCompositeOperation="source-in";aK.fillStyle=i;aK.fillRect(aH,aG,aI,aQ);aK.restore();aK.globalCompositeOperation="destination-over";aK.drawImage(p,0,0,aI,aQ,aH,aG,aI,aQ);aK.globalCompositeOperation="source-over";return 1};x.DrawBlock=function(aI,i,aH,j,aF,aG){aI.fillStyle=aG;ap(aI,i,aH,j,aF,this.radius)};x.DrawSimple=function(aH,i,j,aG){var aF=this.tc;aH.setTransform(1,0,0,1,0,0);aH.strokeStyle=aF.outlineColour;aH.lineWidth=aF.outlineThickness;aH.shadowBlur=aH.shadowOffsetX=aH.shadowOffsetY=0;aH.globalAlpha=1;return this.drawFunc(aH,this.x,this.y,this.w,this.h,aF.outlineColour,i,j,aG)};x.DrawPulsate=function(aI,i,j,aG){var aH=G()-this.ts,aF=this.tc;aI.setTransform(1,0,0,1,0,0);aI.strokeStyle=aF.outlineColour;aI.lineWidth=aF.outlineThickness;aI.shadowBlur=aI.shadowOffsetX=aI.shadowOffsetY=0;aI.globalAlpha=aF.pulsateTo+((1-aF.pulsateTo)*(0.5+(w(2*Math.PI*aH/(1000*aF.pulsateTime))/2)));return this.drawFunc(aI,this.x,this.y,this.w,this.h,aF.outlineColour,i,j,aG)};x.Active=function(aF,i,j){return(i>=this.x&&j>=this.y&&i<=this.x+this.w&&j<=this.y+this.h)};x.PreDraw=x.PostDraw=x.LastDraw=ay;function e(aG,aQ,aM,aP,aN,aH,aF,aJ,aO,aI,aL,j,aK,i){this.tc=aG;this.image=null;this.text=aQ;this.text_original=i;this.line_widths=[];this.title=aM.title||null;this.a=aM;this.position=new ad(aP[0],aP[1],aP[2]);this.x=this.y=this.z=0;this.w=aN;this.h=aH;this.colour=aF||aG.textColour;this.bgColour=aJ||aG.bgColour;this.bgRadius=aO|0;this.bgOutline=aI||this.colour;this.bgOutlineThickness=aL|0;this.textFont=j||aG.textFont;this.padding=aK|0;this.sc=this.alpha=1;this.weighted=!aG.weight}c=e.prototype;c.Init=function(j){var i=this.tc;this.outline=new J(i,this);this.textHeight=i.textHeight;if(this.HasText()){this.Measure(i.ctxt,i)}else{this.w=this.iw;this.h=this.ih}this.SetShadowColour=i.shadowAlpha?this.SetShadowColourAlpha:this.SetShadowColourFixed;this.SetDraw(i)};c.Draw=ay;c.HasText=function(){return this.text&&this.text[0].length>0};c.EqualTo=function(aF){var j=aF.getElementsByTagName("img");if(this.a.href!=aF.href){return 0}if(j.length){return this.image.src==j[0].src}return(aF.innerText||aF.textContent)==this.text_original};c.SetImage=function(j){this.image=this.fimage=j};c.SetDraw=function(i){this.Draw=this.fimage?(i.ie>7?this.DrawImageIE:this.DrawImage):this.DrawText;i.noSelect&&(this.CheckActive=ay)};c.MeasureText=function(aI){var aG,aF=this.text.length,j=0,aH;for(aG=0;aG<aF;++aG){this.line_widths[aG]=aH=aI.measureText(this.text[aG]).width;j=s(j,aH)}return j};c.Measure=function(aK,aN){var aL=t(this.text,this.textFont,this.textHeight),aO,i,aH,j,aF,aJ,aM,aG,aI;aM=aL?aL.max.y+aL.min.y:this.textHeight;aK.font=this.font=this.textHeight+"px "+this.textFont;aJ=this.MeasureText(aK);if(aN.txtOpt){aO=aN.txtScale;i=aO*this.textHeight;aH=i+"px "+this.textFont;j=[aO*aN.shadowOffset[0],aO*aN.shadowOffset[1]];aK.font=aH;aF=this.MeasureText(aK);aI=new g(this.text,aH,aF+aO,(aO*aM)+aO,aF,this.line_widths,aN.textAlign,aN.textVAlign,aO);if(this.image){aI.SetImage(this.image,this.iw,this.ih,aN.imagePosition,aN.imagePadding,aN.imageAlign,aN.imageVAlign,aN.imageScale)}aG=aI.Create(this.colour,this.bgColour,this.bgOutline,aO*this.bgOutlineThickness,aN.shadow,aO*aN.shadowBlur,j,aO*this.padding,aO*this.bgRadius);if(aN.outlineMethod=="colour"){this.oimage=aI.Create(aN.outlineColour,this.bgColour,aN.outlineColour,aO*this.bgOutlineThickness,aN.shadow,aO*aN.shadowBlur,j,aO*this.padding,aO*this.bgRadius)}else{if(aN.outlineMethod=="size"){aL=t(this.text,this.textFont,this.textHeight+aN.outlineIncrease);i=aL.max.y+aL.min.y;aH=(aO*(this.textHeight+aN.outlineIncrease))+"px "+this.textFont;aK.font=aH;aF=this.MeasureText(aK);aI=new g(this.text,aH,aF+aO,(aO*i)+aO,aF,this.line_widths,aN.textAlign,aN.textVAlign,aO);if(this.image){aI.SetImage(this.image,this.iw+aN.outlineIncrease,this.ih+aN.outlineIncrease,aN.imagePosition,aN.imagePadding,aN.imageAlign,aN.imageVAlign,aN.imageScale)}this.oimage=aI.Create(this.colour,this.bgColour,this.bgOutline,aO*this.bgOutlineThickness,aN.shadow,aO*aN.shadowBlur,j,aO*this.padding,aO*this.bgRadius);if(aN.outlineIncrease>0){aG=v(aG,this.oimage.width,this.oimage.height)}else{this.oimage=v(this.oimage,aG.width,aG.height)}}}if(aG){this.fimage=aG;aJ=this.fimage.width/aO;aM=this.fimage.height/aO}this.SetDraw(aN);aN.txtOpt=!!this.fimage}this.h=aM;this.w=aJ};c.SetFont=function(j,aG,aF,i){this.textFont=j;this.colour=aG;this.bgColour=aF;this.bgOutline=i;this.Measure(this.tc.ctxt,this.tc)};c.SetWeight=function(aF){var j=this.tc,aH=j.weightMode.split(/[, ]/),i,aG,aI=aF.length;if(!this.HasText()){return}this.weighted=true;for(aG=0;aG<aI;++aG){i=aH[aG]||"size";if("both"==i){this.Weight(aF[aG],j.ctxt,j,"size",j.min_weight[aG],j.max_weight[aG],aG);this.Weight(aF[aG],j.ctxt,j,"colour",j.min_weight[aG],j.max_weight[aG],aG)}else{this.Weight(aF[aG],j.ctxt,j,i,j.min_weight[aG],j.max_weight[aG],aG)}}this.Measure(j.ctxt,j)};c.Weight=function(aF,aK,aG,j,aJ,aH,aI){aF=isNaN(aF)?1:aF;var i=(aF-aJ)/(aH-aJ);if("colour"==j){this.colour=k(aG,i,aI)}else{if("bgcolour"==j){this.bgColour=k(aG,i,aI)}else{if("bgoutline"==j){this.bgOutline=k(aG,i,aI)}else{if("size"==j){if(aG.weightSizeMin>0&&aG.weightSizeMax>aG.weightSizeMin){this.textHeight=aG.weightSize*(aG.weightSizeMin+(aG.weightSizeMax-aG.weightSizeMin)*i)}else{this.textHeight=s(1,aF*aG.weightSize)}}}}}};c.SetShadowColourFixed=function(aF,j,i){aF.shadowColor=j};c.SetShadowColourAlpha=function(aF,j,i){aF.shadowColor=U(j,i)};c.DrawText=function(aH,aK,aG){var aL=this.tc,aJ=this.x,aI=this.y,aM=this.sc,j,aF;aH.globalAlpha=this.alpha;aH.fillStyle=this.colour;aL.shadow&&this.SetShadowColour(aH,aL.shadow,this.alpha);aH.font=this.font;aJ+=aK/aM;aI+=(aG/aM)-(this.h/2);for(j=0;j<this.text.length;++j){aF=aJ;if("right"==aL.textAlign){aF+=this.w/2-this.line_widths[j]}else{if("centre"==aL.textAlign){aF-=this.line_widths[j]/2}else{aF-=this.w/2}}aH.setTransform(aM,0,0,aM,aM*aF,aM*aI);aH.fillText(this.text[j],0,0);aI+=this.textHeight}};c.DrawImage=function(aH,aO,aG,aJ){var aL=this.x,aI=this.y,aP=this.sc,j=aJ||this.fimage,aM=this.w,aF=this.h,aK=this.alpha,aN=this.shadow;aH.globalAlpha=aK;aN&&this.SetShadowColour(aH,aN,aK);aL+=(aO/aP)-(aM/2);aI+=(aG/aP)-(aF/2);aH.setTransform(aP,0,0,aP,aP*aL,aP*aI);aH.drawImage(j,0,0,aM,aF)};c.DrawImageIE=function(aH,aL,aG){var j=this.fimage,aM=this.sc,aK=j.width=this.w*aM,aF=j.height=this.h*aM,aJ=(this.x*aM)+aL-(aK/2),aI=(this.y*aM)+aG-(aF/2);aH.setTransform(1,0,0,1,0,0);aH.globalAlpha=this.alpha;aH.drawImage(j,aJ,aI)};c.Calc=function(i,aF){var j,aI=this.tc,aH=aI.minBrightness,aG=aI.maxBrightness,aJ=aI.max_radius;j=i.xform(this.position);this.xformed=j;j=V(aI,j,aI.stretchX,aI.stretchY);this.x=j.x;this.y=j.y;this.z=j.z;this.sc=j.w;this.alpha=aF*at(aH+(aG-aH)*(aJ-this.z)/(2*aJ),0,1)};c.UpdateActive=function(aK,aF,aI){var aH=this.outline,j=this.w,aG=this.h,i=this.x-j/2,aJ=this.y-aG/2;aH.Update(i,aJ,j,aG,this.sc,this.z,aF,aI);return aH};c.CheckActive=function(aH,i,aG){var j=this.tc,aF=this.UpdateActive(aH,i,aG);return aF.Active(aH,j.mx,j.my)?aF:null};c.Clicked=function(aI){var j=this.a,aF=j.target,aG=j.href,i;if(aF!=""&&aF!="_self"){if(self.frames[aF]){self.frames[aF].document.location=aG}else{try{if(top.frames[aF]){top.frames[aF].document.location=aG;return}}catch(aH){}window.open(aG,aF)}return}if(C.createEvent){i=C.createEvent("MouseEvents");i.initMouseEvent("click",1,1,window,0,0,0,0,0,0,0,0,0,0,null);if(!j.dispatchEvent(i)){return}}else{if(j.fireEvent){if(!j.fireEvent("onclick")){return}}}C.location=aG};function y(aL,j,aG){var aF,aI,aK=C.getElementById(aL),aH=["id","class","innerHTML"],aJ;if(!aK){throw 0}if(ah(window.G_vmlCanvasManager)){aK=window.G_vmlCanvasManager.initElement(aK);this.ie=parseFloat(navigator.appVersion.split("MSIE")[1])}if(aK&&(!aK.getContext||!aK.getContext("2d").fillText)){aI=C.createElement("DIV");for(aF=0;aF<aH.length;++aF){aI[aH[aF]]=aK[aH[aF]]}aK.parentNode.insertBefore(aI,aK);aK.parentNode.removeChild(aK);throw 0}for(aF in y.options){this[aF]=aG&&ah(aG[aF])?aG[aF]:(ah(y[aF])?y[aF]:y.options[aF])}this.canvas=aK;this.ctxt=aK.getContext("2d");this.z1=250/s(this.depth,0.001);this.z2=this.z1/this.zoom;this.radius=aB(aK.height,aK.width)*0.0075;this.max_radius=100;this.max_weight=[];this.min_weight=[];this.textFont=this.textFont&&o(this.textFont);this.textHeight*=1;this.pulsateTo=at(this.pulsateTo,0,1);this.minBrightness=at(this.minBrightness,0,1);this.maxBrightness=at(this.maxBrightness,this.minBrightness,1);this.ctxt.textBaseline="top";this.lx=(this.lock+"").indexOf("x")+1;this.ly=(this.lock+"").indexOf("y")+1;this.frozen=this.dx=this.dy=this.fixedAnim=this.touchState=0;this.fixedAlpha=1;this.source=j||aL;this.repeatTags=aB(64,~~this.repeatTags);this.minTags=aB(200,~~this.minTags);if(this.minTags>0&&this.repeatTags<1&&(aF=this.GetTags().length)){this.repeatTags=ao(this.minTags/aF)-1}this.transform=R.Identity();this.startTime=this.time=G();this.mx=this.my=-1;this.centreImage&&an(this);this.Animate=this.dragControl?this.AnimateDrag:this.AnimatePosition;this.animTiming=(typeof y[this.animTiming]=="function"?y[this.animTiming]:y.Smooth);if(this.shadowBlur||this.shadowOffset[0]||this.shadowOffset[1]){this.ctxt.shadowColor=this.shadow;this.shadow=this.ctxt.shadowColor;this.shadowAlpha=ak()}else{delete this.shadow}this.Load();if(j&&this.hideTags){(function(i){if(y.loaded){i.HideTags()}else{ac("load",function(){i.HideTags()},window)}})(this)}this.yaw=this.initial?this.initial[0]*this.maxSpeed:0;this.pitch=this.initial?this.initial[1]*this.maxSpeed:0;if(this.tooltip){this.ctitle=aK.title;aK.title="";if(this.tooltip=="native"){this.Tooltip=this.TooltipNative}else{this.Tooltip=this.TooltipDiv;if(!this.ttdiv){this.ttdiv=C.createElement("div");this.ttdiv.className=this.tooltipClass;this.ttdiv.style.position="absolute";this.ttdiv.style.zIndex=aK.style.zIndex+1;ac("mouseover",function(i){i.target.style.display="none"},this.ttdiv);C.body.appendChild(this.ttdiv)}}}else{this.Tooltip=this.TooltipNone}if(!this.noMouse&&!b[aL]){b[aL]=[["mousemove",ae],["mouseout",B],["mouseup",aC],["touchstart",T],["touchend",r],["touchcancel",r],["touchmove",ax]];if(this.dragControl){b[aL].push(["mousedown",z]);b[aL].push(["selectstart",ay])}if(this.wheelZoom){b[aL].push(["mousewheel",af]);b[aL].push(["DOMMouseScroll",af])}for(aF=0;aF<b[aL].length;++aF){ac(b[aL][aF][0],b[aL][aF][1],aK)}}if(!y.started){aJ=window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;y.NextFrame=aJ?y.NextFrameRAF:y.NextFrameTimeout;y.interval=this.interval;y.NextFrame(this.interval);y.started=1}}Q=y.prototype;Q.SourceElements=function(){if(C.querySelectorAll){return C.querySelectorAll("#"+this.source)}return[C.getElementById(this.source)]};Q.HideTags=function(){var aF=this.SourceElements(),j;for(j=0;j<aF.length;++j){aF[j].style.display="none"}};Q.GetTags=function(){var aK=this.SourceElements(),aJ,aG=[],aI,aH,aF;for(aF=0;aF<=this.repeatTags;++aF){for(aI=0;aI<aK.length;++aI){aJ=aK[aI].getElementsByTagName("a");for(aH=0;aH<aJ.length;++aH){aG.push(aJ[aH])}}}return aG};Q.Message=function(aK){var aM=[],aG,j,aF=aK.split(""),aI,aL,aJ,aH;for(aG=0;aG<aF.length;++aG){if(aF[aG]!=" "){j=aG-aF.length/2;aI=C.createElement("A");aI.href="#";aI.innerText=aF[aG];aJ=100*ag(j/9);aH=-100*w(j/9);aL=new e(this,aF[aG],aI,[aJ,0,aH],2,18,"#000","#fff",0,0,0,"monospace",2,aF[aG]);aL.Init();aM.push(aL)}}return aM};Q.CreateTag=function(aJ){var aM,aH,aN,aI,aL,aF,aK,aG,j=[0,0,0];if("text"!=this.imageMode){aM=aJ.getElementsByTagName("img");if(aM.length){aH=new Image;aH.src=aM[0].src;if(!this.imageMode){aN=new e(this,"",aJ,j,0,0);aN.SetImage(aH);au(aH,aM[0],aN,this);return aN}}}if("image"!=this.imageMode){aL=new az(aJ);aI=aL.Lines();if(!aL.Empty()){aF=this.textFont||o(Y(aJ,"font-family"));if(this.splitWidth){aI=aL.SplitWidth(this.splitWidth,this.ctxt,aF,this.textHeight)}aK=this.bgColour=="tag"?Y(aJ,"background-color"):this.bgColour;aG=this.bgOutline=="tag"?Y(aJ,"color"):this.bgOutline}else{aL=null}}if(aL||aH){aN=new e(this,aI,aJ,j,2,this.textHeight+2,this.textColour||Y(aJ,"color"),aK,this.bgRadius,aG,this.bgOutlineThickness,aF,this.padding,aL&&aL.original);if(aH){aN.SetImage(aH);au(aH,aM[0],aN,this)}else{aN.Init()}return aN}};Q.UpdateTag=function(aF,i){var aI=this.textColour||Y(i,"color"),j=this.textFont||o(Y(i,"font-family")),aH=this.bgColour=="tag"?Y(i,"background-color"):this.bgColour,aG=this.bgOutline=="tag"?Y(i,"color"):this.bgOutline;aF.a=i;aF.title=i.title;if(aF.colour!=aI||aF.textFont!=j||aF.bgColour!=aH||aF.bgOutline!=aG){aF.SetFont(j,aI,aH,aG)}};Q.Weight=function(aL){var aH=aL.length,aJ,aF,aM,aI=[],j,aG=this.weightFrom?this.weightFrom.split(/[, ]/):[null],aK=aG.length;for(aF=0;aF<aH;++aF){aI[aF]=[];for(aM=0;aM<aK;++aM){aJ=u(aL[aF].a,aG[aM],this.textHeight);if(!this.max_weight[aM]||aJ>this.max_weight[aM]){this.max_weight[aM]=aJ}if(!this.min_weight[aM]||aJ<this.min_weight[aM]){this.min_weight[aM]=aJ}aI[aF][aM]=aJ}}for(aM=0;aM<aK;++aM){if(this.max_weight[aM]>this.min_weight[aM]){j=1}}if(j){for(aF=0;aF<aH;++aF){aL[aF].SetWeight(aI[aF])}}};Q.Load=function(){var aP=this.GetTags(),aK=[],aN,aO,aJ,aG,aF,j,aH,aM,aI=[],aL={sphere:q,vcylinder:al,hcylinder:ar,vring:d,hring:n};if(aP.length){aI.length=aP.length;for(aM=0;aM<aP.length;++aM){aI[aM]=aM}this.shuffleTags&&am(aI);aG=100*this.radiusX;aF=100*this.radiusY;j=100*this.radiusZ;this.max_radius=s(aG,s(aF,j));for(aM=0;aM<aP.length;++aM){aO=this.CreateTag(aP[aI[aM]]);if(aO){aK.push(aO)}}this.weight&&this.Weight(aK,true);if(this.shapeArgs){this.shapeArgs[0]=aK.length}else{aJ=this.shape.toString().split(/[(),]/);aN=aJ.shift();if(typeof window[aN]==="function"){this.shape=window[aN]}else{this.shape=aL[aN]||aL.sphere}this.shapeArgs=[aK.length,aG,aF,j].concat(aJ)}aH=this.shape.apply(this,this.shapeArgs);this.listLength=aK.length;for(aM=0;aM<aK.length;++aM){aK[aM].position=new ad(aH[aM][0],aH[aM][1],aH[aM][2])}}if(this.noTagsMessage&&!aK.length){aK=this.Message("No tags")}this.taglist=aK};Q.Update=function(){var aO=this.GetTags(),aN=[],aI=this.taglist,aP,aM=[],aK=[],aG,aL,aF,aJ,aH;if(!this.shapeArgs){return this.Load()}if(aO.length){aF=this.listLength=aO.length;aL=aI.length;for(aJ=0;aJ<aL;++aJ){aN.push(aI[aJ]);aK.push(aJ)}for(aJ=0;aJ<aF;++aJ){for(aH=0,aP=0;aH<aL;++aH){if(aI[aH].EqualTo(aO[aJ])){this.UpdateTag(aN[aH],aO[aJ]);aP=aK[aH]=-1}}if(!aP){aM.push(aJ)}}for(aJ=0,aH=0;aJ<aL;++aJ){if(aK[aH]==-1){aK.splice(aH,1)}else{++aH}}if(aK.length){am(aK);while(aK.length&&aM.length){aJ=aK.shift();aH=aM.shift();aN[aJ]=this.CreateTag(aO[aH])}aK.sort(function(j,i){return j-i});while(aK.length){aN.splice(aK.pop(),1)}}aH=aN.length/(aM.length+1);aJ=0;while(aM.length){aN.splice(ao(++aJ*aH),0,this.CreateTag(aO[aM.shift()]))}this.shapeArgs[0]=aF=aN.length;aG=this.shape.apply(this,this.shapeArgs);for(aJ=0;aJ<aF;++aJ){aN[aJ].position=new ad(aG[aJ][0],aG[aJ][1],aG[aJ][2])}this.weight&&this.Weight(aN)}this.taglist=aN};Q.SetShadow=function(i){i.shadowBlur=this.shadowBlur;i.shadowOffsetX=this.shadowOffset[0];i.shadowOffsetY=this.shadowOffset[1]};Q.Draw=function(aP){if(this.paused){return}var aJ=this.canvas,aH=aJ.width,aO=aJ.height,aR=0,aG=(aP-this.time)*y.interval/1000,aN=aH/2+this.offsetX,aM=aO/2+this.offsetY,aV=this.ctxt,aL,aW,aT,aF=-1,aI=this.taglist,aS=aI.length,j=this.frontSelect,aQ=(this.centreFunc==ay),aK;this.time=aP;if(this.frozen&&this.drawn){return this.Animate(aH,aO,aG)}aK=this.AnimateFixed();aV.setTransform(1,0,0,1,0,0);for(aT=0;aT<aS;++aT){aI[aT].Calc(this.transform,this.fixedAlpha)}aI=A(aI,function(aX,i){return i.z-aX.z});if(aK&&this.fixedAnim.active){aL=this.fixedAnim.tag.UpdateActive(aV,aN,aM)}else{this.active=null;for(aT=0;aT<aS;++aT){aW=this.mx>=0&&this.my>=0&&this.taglist[aT].CheckActive(aV,aN,aM);if(aW&&aW.sc>aR&&(!j||aW.z<=0)){aL=aW;aF=aT;aL.tag=this.taglist[aT];aR=aW.sc}}this.active=aL}this.txtOpt||(this.shadow&&this.SetShadow(aV));aV.clearRect(0,0,aH,aO);for(aT=0;aT<aS;++aT){if(!aQ&&aI[aT].z<=0){try{this.centreFunc(aV,aH,aO,aN,aM)}catch(aU){alert(aU);this.centreFunc=ay}aQ=true}if(!(aL&&aL.tag==aI[aT]&&aL.PreDraw(aV,aI[aT],aN,aM))){aI[aT].Draw(aV,aN,aM)}aL&&aL.tag==aI[aT]&&aL.PostDraw(aV)}if(this.freezeActive&&aL){this.Freeze()}else{this.UnFreeze();this.drawn=(aS==this.listLength)}if(this.fixedCallback){this.fixedCallback(this,this.fixedCallbackTag);this.fixedCallback=null}aK||this.Animate(aH,aO,aG);aL&&aL.LastDraw(aV);aJ.style.cursor=aL?this.activeCursor:"";this.Tooltip(aL,this.taglist[aF])};Q.TooltipNone=function(){};Q.TooltipNative=function(j,i){if(j){this.canvas.title=i&&i.title?i.title:""}else{this.canvas.title=this.ctitle}};Q.SetTTDiv=function(aG,j){var i=this,aF=i.ttdiv.style;if(aG!=i.ttdiv.innerHTML){aF.display="none"}i.ttdiv.innerHTML=aG;j&&(j.title=i.ttdiv.innerHTML);if(aF.display=="none"&&!i.tttimer){i.tttimer=setTimeout(function(){var aH=ab(i.canvas.id);aF.display="block";aF.left=aH.x+i.mx+"px";aF.top=aH.y+i.my+24+"px";i.tttimer=null},i.tooltipDelay)}};Q.TooltipDiv=function(j,i){if(j&&i&&i.title){this.SetTTDiv(i.title,i)}else{if(!j&&this.mx!=-1&&this.my!=-1&&this.ctitle.length){this.SetTTDiv(this.ctitle)}else{this.ttdiv.style.display="none"}}};Q.Transform=function(aI,i,aK){if(i||aK){var j=ag(i),aJ=w(i),aL=ag(aK),aH=w(aK),aF=new R([aH,0,aL,0,1,0,-aL,0,aH]),aG=new R([1,0,0,0,aJ,-j,0,j,aJ]);aI.transform=aI.transform.mul(aF.mul(aG))}};Q.AnimateFixed=function(){var aF,j,aH,i,aG;if(this.fadeIn){j=G()-this.startTime;if(j>=this.fadeIn){this.fadeIn=0;this.fixedAlpha=1}else{this.fixedAlpha=j/this.fadeIn}}if(this.fixedAnim){if(!this.fixedAnim.transform){this.fixedAnim.transform=this.transform}aF=this.fixedAnim,j=G()-aF.t0,aH=aF.angle,i,aG=this.animTiming(aF.t,j);this.transform=aF.transform;if(j>=aF.t){this.fixedCallbackTag=aF.tag;this.fixedCallback=aF.cb;this.fixedAnim=this.yaw=this.pitch=0}else{aH*=aG}i=R.Rotation(aH,aF.axis);this.transform=this.transform.mul(i);return(this.fixedAnim!=0)}return false};Q.AnimatePosition=function(aF,aI,aG){var j=this,i=j.mx,aK=j.my,aH,aJ;if(!j.frozen&&i>=0&&aK>=0&&i<aF&&aK<aI){aH=j.maxSpeed,aJ=j.reverse?-1:1;j.lx||(j.yaw=((i*2*aH/aF)-aH)*aJ*aG);j.ly||(j.pitch=((aK*2*aH/aI)-aH)*-aJ*aG);j.initial=null}else{if(!j.initial){if(j.frozen&&!j.freezeDecel){j.yaw=j.pitch=0}else{j.Decel(j)}}}this.Transform(j,j.pitch,j.yaw)};Q.AnimateDrag=function(j,aH,aG){var i=this,aF=100*aG*i.maxSpeed/i.max_radius/i.zoom;if(i.dx||i.dy){i.lx||(i.yaw=i.dx*aF/i.stretchX);i.ly||(i.pitch=i.dy*-aF/i.stretchY);i.dx=i.dy=0;i.initial=null}else{if(!i.initial){i.Decel(i)}}this.Transform(i,i.pitch,i.yaw)};Q.Freeze=function(){if(!this.frozen){this.preFreeze=[this.yaw,this.pitch];this.frozen=1;this.drawn=0}};Q.UnFreeze=function(){if(this.frozen){this.yaw=this.preFreeze[0];this.pitch=this.preFreeze[1];this.frozen=0}};Q.Decel=function(i){var aF=i.minSpeed,aG=L(i.yaw),j=L(i.pitch);if(!i.lx&&aG>aF){i.yaw=aG>i.z0?i.yaw*i.decel:0}if(!i.ly&&j>aF){i.pitch=j>i.z0?i.pitch*i.decel:0}};Q.Zoom=function(i){this.z2=this.z1*(1/i);this.drawn=0};Q.Clicked=function(aF){var i=this.active;try{if(i&&i.tag){if(this.clickToFront===false||this.clickToFront===null){i.tag.Clicked(aF)}else{this.TagToFront(i.tag,this.clickToFront,function(){i.tag.Clicked(aF)},true)}}}catch(j){}};Q.Wheel=function(j){var aF=this.zoom+this.zoomStep*(j?1:-1);this.zoom=aB(this.zoomMax,s(this.zoomMin,aF));this.Zoom(this.zoom)};Q.BeginDrag=function(i){this.down=S(i,this.canvas);i.cancelBubble=true;i.returnValue=false;i.preventDefault&&i.preventDefault()};Q.Drag=function(aH,aG){if(this.dragControl&&this.down){var aF=this.dragThreshold*this.dragThreshold,j=aG.x-this.down.x,i=aG.y-this.down.y;if(this.dragging||j*j+i*i>aF){this.dx=j;this.dy=i;this.dragging=1;this.down=aG}}return this.dragging};Q.EndDrag=function(){var i=this.dragging;this.dragging=this.down=null;return i};function D(aF){var j=aF.targetTouches[0],i=aF.targetTouches[1];return F(aq(i.pageX-j.pageX,2)+aq(i.pageY-j.pageY,2))}Q.BeginPinch=function(i){this.pinched=[D(i),this.zoom];i.preventDefault&&i.preventDefault()};Q.Pinch=function(j){var aG,aF,i=this.pinched;if(!i){return}aF=D(j);aG=i[1]*aF/i[0];this.zoom=aB(this.zoomMax,s(this.zoomMin,aG));this.Zoom(this.zoom)};Q.EndPinch=function(i){this.pinched=null};Q.Pause=function(){this.paused=true};Q.Resume=function(){this.paused=false};Q.SetSpeed=function(j){this.initial=j;this.yaw=j[0]*this.maxSpeed;this.pitch=j[1]*this.maxSpeed};Q.FindTag=function(aF){if(!ah(aF)){return null}ah(aF.index)&&(aF=aF.index);if(!I(aF)){return this.taglist[aF]}var aG,aH,j;if(ah(aF.id)){aG="id",aH=aF.id}else{if(ah(aF.text)){aG="innerText",aH=aF.text}}for(j=0;j<this.taglist.length;++j){if(this.taglist[j].a[aG]==aH){return this.taglist[j]}}};Q.RotateTag=function(aN,aG,aM,i,aK,aF){var aL=aN.xformed,aI=new ad(aL.x,aL.y,aL.z),aH=ai(aM,aG),j=aI.angle(aH),aJ=aI.cross(aH).unit();if(j==0){this.fixedCallbackTag=aN;this.fixedCallback=aK}else{this.fixedAnim={angle:-j,axis:aJ,t:i,t0:G(),cb:aK,tag:aN,active:aF}}};Q.TagToFront=function(i,aF,aG,j){this.RotateTag(i,0,0,aF,aG,j)};y.Start=function(aF,i,j){y.Delete(aF);y.tc[aF]=new y(aF,i,j)};function aw(i,j){y.tc[j]&&y.tc[j][i]()}y.Linear=function(i,j){return j/i};y.Smooth=function(i,j){return 0.5-w(j*Math.PI/i)/2};y.Pause=function(i){aw("Pause",i)};y.Resume=function(i){aw("Resume",i)};y.Reload=function(i){aw("Load",i)};y.Update=function(i){aw("Update",i)};y.SetSpeed=function(j,i){if(I(i)&&y.tc[j]&&!isNaN(i[0])&&!isNaN(i[1])){y.tc[j].SetSpeed(i);return true}return false};y.TagToFront=function(j,i){if(!I(i)){return false}i.lat=i.lng=0;return y.RotateTag(j,i)};y.RotateTag=function(aF,i){if(I(i)&&y.tc[aF]){if(isNaN(i.time)){i.time=500}var j=y.tc[aF].FindTag(i);if(j){y.tc[aF].RotateTag(j,i.lat,i.lng,i.time,i.callback,i.active);return true}}return false};y.Delete=function(aG){var j,aF;if(b[aG]){aF=C.getElementById(aG);if(aF){for(j=0;j<b[aG].length;++j){a(b[aG][j][0],b[aG][j][1],aF)}}}delete b[aG];delete y.tc[aG]};y.NextFrameRAF=function(){requestAnimationFrame(E)};y.NextFrameTimeout=function(i){setTimeout(O,i)};y.tc={};y.options={z1:20000,z2:20000,z0:0.0002,freezeActive:false,freezeDecel:false,activeCursor:"pointer",pulsateTo:1,pulsateTime:3,reverse:false,depth:0.5,maxSpeed:0.05,minSpeed:0,decel:0.95,interval:20,minBrightness:0.1,maxBrightness:1,outlineColour:"#ffff99",outlineThickness:2,outlineOffset:5,outlineMethod:"outline",outlineRadius:0,textColour:"#ff99ff",textHeight:15,textFont:"Helvetica, Arial, sans-serif",shadow:"#000",shadowBlur:0,shadowOffset:[0,0],initial:null,hideTags:true,zoom:1,weight:false,weightMode:"size",weightFrom:null,weightSize:1,weightSizeMin:null,weightSizeMax:null,weightGradient:{0:"#f00",0.33:"#ff0",0.66:"#0f0",1:"#00f"},txtOpt:true,txtScale:2,frontSelect:false,wheelZoom:true,zoomMin:0.3,zoomMax:3,zoomStep:0.05,shape:"sphere",lock:null,tooltip:null,tooltipDelay:300,tooltipClass:"tctooltip",radiusX:1,radiusY:1,radiusZ:1,stretchX:1,stretchY:1,offsetX:0,offsetY:0,shuffleTags:false,noSelect:false,noMouse:false,imageScale:1,paused:false,dragControl:false,dragThreshold:4,centreFunc:ay,splitWidth:0,animTiming:"Smooth",clickToFront:false,fadeIn:0,padding:0,bgColour:null,bgRadius:0,bgOutline:null,bgOutlineThickness:0,outlineIncrease:4,textAlign:"centre",textVAlign:"middle",imageMode:null,imagePosition:null,imagePadding:2,imageAlign:"centre",imageVAlign:"middle",noTagsMessage:true,centreImage:null,pinchZoom:false,repeatTags:0,minTags:0};for(M in y.options){y[M]=y.options[M]}window.TagCanvas=y;ac("load",function(){y.loaded=1},window)})();
